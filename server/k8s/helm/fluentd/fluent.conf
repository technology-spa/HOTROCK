<system>
  # multi-threading is not likely to be widely supported in conjunction with many 3rd party plugins
  # but it's worth enabling if possible, thanks to Ruby's GIL. See:
  # https://docs.fluentd.org/v1.0/articles/performance-tuning-single-process#multi-workers
  workers 8
  # prevents printing secrets (debug) in stdout of FluentD
  suppress_config_dump
  log_level info
  # json makes it easier to discern how fields are separated
  <log>
    format json
  </log>
</system>

# suppress warnings / verbose logs from fluentd itself.
# i've triggered warnings that generated tens of thousands of messages per second
# just because of a non-fatal mis-configuration.
<match fluent.{warn,debug,trace}>
  @type null
</match>

# fluent-bit forwards here
<source>
  @type forward
  bind 0.0.0.0
  port 24224
  <transport tls>
    version TLSv1_2
    ciphers DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256
    insecure false
    cert_path /fluentd/etc/fluent.crt
    private_key_path /fluentd/etc/fluent.key
  </transport>
  <security>
    self_hostname chip-fd.adatechnologists.com
    shared_key bOpDYXIKq5RSYXDCTw8kVx1YqI5ytrBygXrqZ3d3fja4g1P9UWqsVN0IeopqrYLX
  </security>
</source>

<source>
  @type beats
  # @log_level debug
  @label @WAZUH
  port 5044
  metadata_as_tag true
  # tag wazuh_filebeat
</source>

# we only use fluent.{info,error,fatal} for our aggregators, not with a client's aggregator.
# if on a client's aggregator use separate match tags to point to a different endpoint
# for our monitoring
<match ** fluent.{info,error,fatal}>
  @type elasticsearch
  host elasticsearch-client
  port 9200
  logstash_format true
  logstash_prefix "fluentd"
  type_name fluentd
  # index_name fluentd.${tag}.%Y%m%d
  # https://docs.fluentd.org/v1.0/articles/buffer-section
  <buffer>
    @type memory
    # max retry time default to exponential, but with this max cap here
    retry_max_interval 1800s
    overflow_action block
    flush_thread_count 4
    flush_at_shutdown true
    flush_interval 5s
  </buffer>
</match>

# the index_name is important here. Wazuh's logstash doc:
# https://github.com/wazuh/wazuh-docker/blob/master/logstash/config/01-wazuh.conf#L42
<label @WAZUH>
  # https://github.com/elastic/ecs/issues/35#issuecomment-403059272
  <filter **>
    @type record_transformer
    remove_keys host
  </filter>

  <match **>
    @type elasticsearch
    host elasticsearch-client
    port 9200
    logstash_format true
    logstash_prefix "wazuh-alerts-3.x"
    type_name wazuh
    # index_name fluentd.${tag}.%Y%m%d
    # https://docs.fluentd.org/v1.0/articles/buffer-section
    <buffer>
      @type memory
      # max retry time default to exponential, but with this max cap here.
      # 1800s = 30m
      retry_max_interval 1800s
      overflow_action block
      flush_thread_count 4
      flush_at_shutdown true
      flush_interval 5s
    </buffer>
  </match>
</label>

# for testing
# <match **>
#   @type stdout
# </match>
