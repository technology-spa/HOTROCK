<system>
  # multi-threading is not likely to be widely supported in conjunction with many 3rd party plugins
  # but it's worth enabling if possible, thanks to Ruby's GIL. See:
  # https://docs.fluentd.org/v1.0/articles/performance-tuning-single-process#multi-workers
  # workers 8
  # prevents printing secrets (debug) in stdout of FluentD
  suppress_config_dump
  log_level debug
  # json makes it easier to discern how fields are separated
  <log>
    format json
  </log>
</system>

# suppress warnings / verbose logs from fluentd itself.
# i've triggered warnings that generated tens of thousands of messages per second
# just because of a non-fatal mis-configuration.
# <match fluent.{warn,debug,trace}>
# suppress debug and
<match fluent.{debug,trace}>
  @type null
</match>

<source>
  @type syslog
  port 514
  bind 0.0.0.0
  protocol_type udp
  tag syslog
</source>

<source>
  @type secure_forward
  port 1514
  bind 0.0.0.0
  shared_key MDAxIDE4NWVlNjE1Y2YzYiBhbnkgMGNmMDFiYTM3NmMxY2JjNjU0NDAwYmFhZDY1ZWU1YjcyMGI2NDY3ODhkNGQzMjM5ZTdlNGVmNzQzMGFjMDA4Nw==
  secure no
  self_hostname "#{Socket.gethostname}"
  tag wazuh
</source>

<source>
  @type syslog
  port 1515
  bind 0.0.0.0
  protocol_type udp
  tag cisco_asa
</source>

<source>
  @type beats
  port 5044
  metadata_as_tag true
</source>

# https://docs.fluentd.org/v1.0/articles/filter_parser
<filter cisco_asa.**>
  @type parser
  format cisco_asa
  key_name message
  # don't drop if parsing fails
  emit_invalid_record_to_error false
</filter>

<filter **>
  @type record_transformer
  <record>
    aggregator_hostname ${hostname}
  </record>
</filter>

# we only use fluent.{info,error,fatal} for our aggregators, not with a client's aggregator.
# if on a client's aggregator use separate match tags to point to a different endpoint
# for our monitoring
<match ** fluent.{info,error,fatal}>
  @type secure_forward
  shared_key bOpDYXIKq5RSYXDCTw8kVx1YqI5ytrBygXrqZ3d3fja4g1P9UWqsVN0IeopqrYLX
  self_hostname "#{Socket.gethostname}"
  secure no
  ca_cert_path /etc/td-agent/tls/chipper-ca.pem
   <server>
    host chip-fd.adatechnologists.com
    port 443
  </server>
</match>
